name: Deploy Notebooks to GitHub Pages

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install marimo

      - name: Export all notebooks in readonly mode
        run: |
          mkdir -p docs
          for dir in problems/*; do
            if [ -d "$dir" ] && [ -f "$dir/notebook.py" ]; then
              problem_number=$(echo "$dir" | grep -o '[0-9]*')
              mkdir -p "docs/$problem_number"
              marimo export html-wasm "$dir/notebook.py" --mode run --no-show-code -o "docs/$problem_number"
            fi
          done

      - name: Add custom CSS file
        run: |
          mkdir -p docs/assets
          # Single-quoted heredoc so that Bash does NOT parse quotes or backslashes
          cat <<'EOF' > docs/assets/style.css
@import url("https://fonts.googleapis.com/css2?family=Merriweather:wght@300..900&family=Fira+Code:wght@300..700&display=swap");
@import url("https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,200..900;1,200..900&display=swap");

/* Font and Radius Variables */
:root {
    --monospace-font: "Fira Code", monospace;
    --text-font: "Merriweather", serif;
    --heading-font: "Merriweather", serif;
    --radius: 12px;
    --code-font: "Source Code Pro", monospace;
}

/* Mininini Theme Colors */
:root {
    --background: light-dark(#ffffff, #0a0a0a);
    --background-darker: light-dark(#e5e5e5, #020202);
    --foreground: light-dark(#0a0a0a, #f1f1f1);
    --muted: light-dark(#f0f0f0, #1a1a1a);
    --muted-foreground: light-dark(#777777, #bbbbbb);
    --card: light-dark(#fafafa, #151515);
    --card-foreground: light-dark(#222222, #e2e2e2);
    --popover: light-dark(#e8e8e8, #0d0d0d);
    --popover-foreground: light-dark(#0f0f0f, #eeeeee);
    --border: light-dark(#444444, #2e2e2e);
    --input: light-dark(#f5f5f5, #111111);
    --primary: light-dark(#e4e4e7, #a1a1aa);
    --primary-foreground: light-dark(#ffffff, #f1f1f1);
    --secondary: light-dark(#ff44ff, #aa33aa);
    --secondary-foreground: light-dark(#ffffff, #eaeaea);
    --accent: light-dark(#22aaff, #0055ff);
    --accent-foreground: light-dark(#ffffff, #f0f0f0);
    --error: light-dark(#ff0033, #ff3355);
    --success: light-dark(#00cc66, #00aa44);
    --destructive: light-dark(#cc0033, #bb0022);
    --action: light-dark(#ffee22, #ffcc00);
    --link: light-dark(#22aaff, #3366ff);
    --link-visited: light-dark(#8844ff, #6633cc);
    --base-shadow: light-dark(hsla(0deg, 0%, 80%, 40%), hsla(0deg, 0%, 10%, 60%));
    --base-shadow-darker: light-dark(hsla(0deg, 0%, 65%, 40%), hsla(0deg, 0%, 5%, 60%));
    --base-shadow-opacity: 10%;
}

/* Hide certain elements */
#notebook-actions-dropdown,
button[data-testid="interrupt-button"],
button[data-testid="run-button"],
button[data-testid="command-palette-button"],
input[data-testid="dir-completion-input"],
footer,
.no-print,
button:has(.lucide-database),
div.menu-item:has(.lucide-database),
div.menu-item:has(svg[viewBox="0 0 448 512"]) {
    display: none;
}
EOF

      - name: Inject custom CSS link
        run: |
          find docs -type f -name "index.html" \
            -exec sed -i '/<\/head>/i <link rel="stylesheet" href="..\/assets\/style.css">' {} +

      - name: Force dark theme
        run: |
          find docs -type f -name "index.html" \
            -exec sed -i 's/"theme": "light"/"theme": "dark"/g' {} +

      - name: Create root index.html
        run: |
          echo "<html><body><h1>Notebook Index</h1><ul>" > docs/index.html
          for dir in docs/*; do
            # Skip the assets folder
            if [ -d "$dir" ] && [ "$(basename "$dir")" != "assets" ]; then
              problem_number=$(basename "$dir")
              echo "<li><a href='./$problem_number/index.html'>Problem $problem_number</a></li>" >> docs/index.html
            fi
          done
          echo "</ul></body></html>" >> docs/index.html

      - name: Debug docs directory
        run: |
          ls -R docs

      - name: üì¶ Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs
          name: github-pages
          retention-days: 1

  deploy:
    needs: build
    runs-on: ubuntu-latest

    permissions:
      pages: write
      id-token: write

    steps:
      - name: üåê Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        with:
          artifact_name: github-pages
